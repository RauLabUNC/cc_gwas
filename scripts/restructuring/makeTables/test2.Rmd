---
title: "Multi-Trait Candidate Gene Explorer"
subtitle: "Genes with cis-eQTL Support & NRVM Expression"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    theme: cosmo
    source_code: embed
    navbar:
      - { title: "Gene Table", icon: "fa-table", href: "#gene-table" }
      - { title: "Visualizations", icon: "fa-chart-bar", href: "#visualizations" }
      - { title: "Gene Details", icon: "fa-dna", href: "#gene-details" }
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(dplyr)
library(DT)
library(ggplot2)
library(plotly)
library(shiny)
library(knitr)
library(stringr)
library(purrr)
library(htmltools)
library(wordcloud2)

# Set options
knitr::opts_chunk$set(echo = FALSE)

# Define helper functions
split_trait_drug <- function(trait_drug_str) {
  # Split the trait:drug string into separate values
  if(is.na(trait_drug_str)) return(list(traits = character(0), drugs = character(0)))
  
  traits_drugs <- unlist(strsplit(trait_drug_str, ", "))
  
  # Extract unique traits and drugs
  traits <- unique(sapply(strsplit(traits_drugs, ":"), function(x) if(length(x) > 0) x[1] else NA))
  drugs <- unique(sapply(strsplit(traits_drugs, ":"), function(x) if(length(x) > 1) x[2] else NA))
  
  return(list(traits = traits, drugs = drugs))
}

# Create PubMed link formatter
format_pubmed_links <- function(pubmed_ids) {
  if(is.na(pubmed_ids) || pubmed_ids == "") return("")
  
  ids <- unlist(strsplit(pubmed_ids, ", "))
  ids <- unique(ids)  # Remove duplicates
  
  links <- sapply(ids, function(id) {
    sprintf('<a href="https://pubmed.ncbi.nlm.nih.gov/%s/" target="_blank">%s</a>', id, id)
  })
  
  paste(links, collapse = ", ")
}

# Parse ontology terms
parse_ontology <- function(ontology_str) {
  if(is.na(ontology_str) || ontology_str == "") return(character(0))
  
  # Split by comma and trim whitespace
  terms <- unlist(strsplit(ontology_str, ", "))
  terms <- trimws(terms)
  
  return(terms)
}
```

```{r load-data, include=FALSE}
# Use the correct relative path based on the directory structure
possible_paths <- c(
  "../geneTables/multTrait_cis-eQTL_nrvmExp.csv",
  "multTrait_cis-eQTL_nrvmExp.csv"
)

file_path <- NULL
for (path in possible_paths) {
  if (file.exists(path)) {
    file_path <- path
    break
  }
}

gene_data <- read.csv(file_path, stringsAsFactors = FALSE)

# Process data
processed_data <- gene_data %>%
  rowwise() %>%
  mutate(
    trait_list = list(split_trait_drug(trait_drug)$traits),
    drug_list = list(split_trait_drug(trait_drug)$drugs),
    ontology_list = list(parse_ontology(ontology))
  ) %>%
  ungroup()

# Create a reactive value to store the selected gene
selected_gene <- reactiveVal(NULL)
```

Sidebar {.sidebar}
-----------------------------------------------------------------------

### Filter Options

```{r sidebar}
# Traits filter
all_traits <- unique(unlist(lapply(processed_data$trait_list, function(x) x)))
all_traits <- all_traits[!is.na(all_traits)]
selectInput("trait_filter", "Filter by Trait:", 
            choices = c("All", sort(all_traits)), 
            selected = "All")

# Drugs filter
all_drugs <- unique(unlist(lapply(processed_data$drug_list, function(x) x)))
all_drugs <- all_drugs[!is.na(all_drugs)]
selectInput("drug_filter", "Filter by Drug:", 
            choices = c("All", sort(all_drugs)), 
            selected = "All")

# Disease filter (using simple parsing)
all_diseases <- unique(unlist(strsplit(processed_data$disease, ", ")))
all_diseases <- all_diseases[!is.na(all_diseases)]
selectInput("disease_filter", "Filter by Disease:", 
            choices = c("All", sort(all_diseases)), 
            selected = "All")

# Ontology filter
all_ontology <- unique(unlist(lapply(processed_data$ontology_list, function(x) x)))
all_ontology <- all_ontology[!is.na(all_ontology)]
selectInput("ontology_filter", "Filter by Ontology Term:", 
            choices = c("All", sort(all_ontology)), 
            selected = "All")

# CPM slider
sliderInput("cpm_range", "Expression (CPM):",
            min = 0, 
            max = max(processed_data$avgenes_cpm, na.rm = TRUE),
            value = c(0, max(processed_data$avgenes_cpm, na.rm = TRUE)),
            step = 5)

# Trait count slider
sliderInput("trait_count", "Min Trait-Drug Count:",
            min = min(processed_data$n_trait_drug, na.rm = TRUE),
            max = max(processed_data$n_trait_drug, na.rm = TRUE),
            value = min(processed_data$n_trait_drug, na.rm = TRUE),
            step = 1)

# Sort options
selectInput("sort_by", "Sort By:",
            choices = c("Gene Symbol" = "mouse_gene_symbol",
                       "Trait-Drug Count" = "n_trait_drug",
                       "Expression (CPM)" = "avgenes_cpm"),
            selected = "n_trait_drug")

selectInput("sort_dir", "Sort Direction:",
            choices = c("Descending" = "desc", "Ascending" = "asc"),
            selected = "desc")

# Buttons
actionButton("reset_btn", "Reset Filters", icon = icon("refresh"))
downloadButton("download_btn", "Download Data", icon = icon("download"))
hr()

helpText(
  strong("Instructions:"), 
  "Select a gene from the table to view detailed information in the Gene Details tab.",
  style = "font-size:85%"
)
```

Gene Table {data-icon="fa-table"}
=====================================================================

Row {data-height=700}
-----------------------------------------------------------------------

### Multi-Trait Candidate Genes
#### Protein-coding genes with human orthologues, cis-eQTL support, overlapping miQTL loci, and high NRVM expression

```{r gene-table}
# Filter data
filtered_data <- reactive({
  data <- processed_data
  
  # Filter by trait
  if (input$trait_filter != "All") {
    data <- data %>%
      filter(sapply(trait_list, function(traits) input$trait_filter %in% traits))
  }
  
  # Filter by drug
  if (input$drug_filter != "All") {
    data <- data %>%
      filter(sapply(drug_list, function(drugs) input$drug_filter %in% drugs))
  }
  
  # Filter by disease
  if (input$disease_filter != "All") {
    data <- data %>%
      filter(grepl(input$disease_filter, disease, fixed = TRUE))
  }
  
  # Filter by ontology
  if (input$ontology_filter != "All") {
    data <- data %>%
      filter(sapply(ontology_list, function(terms) input$ontology_filter %in% terms))
  }
  
  # Filter by CPM range
  data <- data %>%
    filter(avgenes_cpm >= input$cpm_range[1],
           avgenes_cpm <= input$cpm_range[2])
  
  # Filter by trait count
  data <- data %>%
    filter(n_trait_drug >= input$trait_count)
  
  # Sort data
  if (input$sort_dir == "asc") {
    data <- data %>% arrange_at(vars(input$sort_by))
  } else {
    data <- data %>% arrange_at(vars(input$sort_by), desc)
  }
  
  return(data)
})

# Display data (remove list columns)
display_data <- reactive({
  filtered_data() %>%
    select(-trait_list, -drug_list, -ontology_list)
})

# Reset button
observeEvent(input$reset_btn, {
  updateSelectInput(session, "trait_filter", selected = "All")
  updateSelectInput(session, "drug_filter", selected = "All")
  updateSelectInput(session, "disease_filter", selected = "All")
  updateSelectInput(session, "ontology_filter", selected = "All")
  
  updateSliderInput(session, "cpm_range", 
                   value = c(0, max(processed_data$avgenes_cpm, na.rm = TRUE)))
  
  updateSliderInput(session, "trait_count", 
                   value = min(processed_data$n_trait_drug, na.rm = TRUE))
  
  # Clear selected gene
  selected_gene(NULL)
})

# Download handler
output$download_btn <- downloadHandler(
  filename = function() {
    paste("gene_data_", Sys.Date(), ".csv", sep = "")
  },
  content = function(file) {
    write.csv(display_data(), file, row.names = FALSE)
  }
)

# Create a compact display version of the table without long text fields
compact_display_data <- reactive({
  display_data() %>%
    select(mouse_gene_symbol, n_trait_drug, avgenes_cpm, mouse_ensembl_id)
})

# Render table
output$gene_table <- renderDT({
  datatable(compact_display_data(),
            options = list(
              pageLength = 15,
              scrollX = TRUE,
              scrollY = "600px",
              dom = 'lrtip',
              columnDefs = list(
                list(
                  targets = "_all",
                  render = JS("function(data, type, row) {
                    if (type === 'display' && data && data.length > 30) {
                      return data.substr(0, 30) + '...';
                    }
                    return data;
                  }")
                )
              )
            ),
            filter = 'top',
            selection = 'single',
            rownames = FALSE,
            colnames = c("Gene Symbol", "Trait-Drug Count", "Expression (CPM)", "Ensembl ID"),
            caption = "Click on a gene to view details") %>%
    formatRound('avgenes_cpm', digits = 2)
})

# When a gene is selected, update the selected_gene reactive value
observeEvent(input$gene_table_rows_selected, {
  if (length(input$gene_table_rows_selected) > 0) {
    row <- input$gene_table_rows_selected
    gene_symbol <- filtered_data()$mouse_gene_symbol[row]
    selected_gene(gene_symbol)
  }
})

DTOutput("gene_table")
```

Row {data-height=300}
-----------------------------------------------------------------------

### Selected Gene Summary

```{r selected-gene-summary}
output$selected_gene_info <- renderUI({
  gene <- selected_gene()
  
  if (is.null(gene)) {
    return(div(
      p("Select a gene from the table above to view summary information."),
      style = "padding: 20px; text-align: center; color: #888;"
    ))
  }
  
  # Get the gene data
  gene_data <- filtered_data() %>%
    filter(mouse_gene_symbol == gene) %>%
    head(1)
  
  if (nrow(gene_data) == 0) {
    return(div(
      p("Gene information not available."),
      style = "padding: 20px; text-align: center; color: #888;"
    ))
  }
  
  # Create a summary card
  div(
    style = "display: flex; flex-wrap: wrap;",
    div(
      style = "flex: 1; min-width: 200px; padding: 10px;",
      h4(strong(gene_data$mouse_gene_symbol), style = "margin-top: 0;"),
      p(strong("Ensembl ID: "), gene_data$mouse_ensembl_id),
      p(strong("Expression (CPM): "), round(gene_data$avgenes_cpm, 2)),
      p(strong("Trait-Drug Count: "), gene_data$n_trait_drug)
    ),
    div(
      style = "flex: 2; min-width: 300px; padding: 10px;",
      p(strong("Traits: "), paste(unlist(gene_data$trait_list), collapse = ", ")),
      p(strong("Drugs: "), paste(unlist(gene_data$drug_list), collapse = ", ")),
      p(strong("Disease: "), if(is.na(gene_data$disease) || gene_data$disease == "") "None" else gene_data$disease)
    )
  )
})

htmlOutput("selected_gene_info")
```

Visualizations {data-icon="fa-chart-bar"}
=====================================================================

Row 
-----------------------------------------------------------------------

### Traits Distribution {data-width=500}

```{r trait-plot}
output$traits_plot <- renderPlotly({
  # Extract all traits from filtered data
  data <- filtered_data()
  
  if (nrow(data) > 0) {
    all_traits <- unlist(lapply(data$trait_list, function(x) x))
    trait_counts <- as.data.frame(table(all_traits))
    colnames(trait_counts) <- c("trait", "count")
    
    # Get top 15 traits
    if (nrow(trait_counts) > 15) {
      trait_counts <- trait_counts %>%
        arrange(desc(count)) %>%
        head(15)
    }
    
    p <- ggplot(trait_counts, aes(x = reorder(trait, count), y = count, fill = trait)) +
      geom_bar(stat = "identity") +
      coord_flip() +
      theme_minimal() +
      labs(x = "", y = "Count", title = "Top Traits") +
      theme(legend.position = "none")
    
    ggplotly(p)
  } else {
    plot_ly() %>% 
      add_annotations(text = "No data available", showarrow = FALSE)
  }
})

plotlyOutput("traits_plot")
```

### Disease Associations {data-width=500}

```{r disease-plot}
output$disease_plot <- renderPlotly({
  data <- filtered_data()
  
  if (nrow(data) > 0) {
    # Extract all diseases
    all_diseases <- unlist(strsplit(data$disease, ", "))
    all_diseases <- all_diseases[!is.na(all_diseases) & all_diseases != ""]
    
    if (length(all_diseases) > 0) {
      disease_counts <- as.data.frame(table(all_diseases))
      colnames(disease_counts) <- c("disease", "count")
      
      # Get top 15 diseases
      if (nrow(disease_counts) > 15) {
        disease_counts <- disease_counts %>%
          arrange(desc(count)) %>%
          head(15)
      }
      
      p <- ggplot(disease_counts, aes(x = reorder(disease, count), y = count, fill = disease)) +
        geom_bar(stat = "identity") +
        coord_flip() +
        theme_minimal() +
        labs(x = "", y = "Count", title = "Top Diseases") +
        theme(legend.position = "none")
      
      ggplotly(p)
    } else {
      plot_ly() %>% 
        add_annotations(text = "No disease data available", showarrow = FALSE)
    }
  } else {
    plot_ly() %>% 
      add_annotations(text = "No data available", showarrow = FALSE)
  }
})

plotlyOutput("disease_plot")
```

Row
-----------------------------------------------------------------------

### Ontology Terms {data-width=500}

```{r ontology-plot}
output$ontology_plot <- renderPlotly({
  data <- filtered_data()
  
  if (nrow(data) > 0) {
    # Extract all ontology terms
    all_terms <- unlist(lapply(data$ontology_list, function(x) x))
    all_terms <- all_terms[!is.na(all_terms) & all_terms != ""]
    
    if (length(all_terms) > 0) {
      term_counts <- as.data.frame(table(all_terms))
      colnames(term_counts) <- c("term", "count")
      
      # Get top 15 terms
      if (nrow(term_counts) > 15) {
        term_counts <- term_counts %>%
          arrange(desc(count)) %>%
          head(15)
      }
      
      p <- ggplot(term_counts, aes(x = reorder(term, count), y = count, fill = term)) +
        geom_bar(stat = "identity") +
        coord_flip() +
        theme_minimal() +
        labs(x = "", y = "Count", title = "Top Ontology Terms") +
        theme(legend.position = "none")
      
      ggplotly(p)
    } else {
      plot_ly() %>% 
        add_annotations(text = "No ontology data available", showarrow = FALSE)
    }
  } else {
    plot_ly() %>% 
      add_annotations(text = "No data available", showarrow = FALSE)
  }
})

plotlyOutput("ontology_plot")
```

### Gene Expression vs Trait-Drug Count {data-width=500}

```{r scatter-plot}
output$scatter_plot <- renderPlotly({
  data <- filtered_data()
  
  if (nrow(data) > 0) {
    # Highlight the selected gene if any
    selected <- selected_gene()
    if (!is.null(selected)) {
      data$selected <- data$mouse_gene_symbol == selected
    } else {
      data$selected <- FALSE
    }
    
    p <- ggplot(data, aes(x = n_trait_drug, y = avgenes_cpm, 
                        text = mouse_gene_symbol, 
                        color = avgenes_cpm,
                        size = selected)) +
      geom_point(alpha = 0.7) +
      scale_color_gradient(low = "blue", high = "red") +
      scale_size_manual(values = c(3, 5), guide = "none") +
      theme_minimal() +
      labs(x = "Number of Trait-Drug Combinations", 
           y = "Average Gene Expression (CPM)") +
      theme(legend.position = "right")
    
    ggplotly(p, tooltip = c("text", "x", "y"))
  } else {
    plot_ly() %>% 
      add_annotations(text = "No data available", showarrow = FALSE)
  }
})

plotlyOutput("scatter_plot")
```

Gene Details {data-icon="fa-dna"}
=====================================================================

Row
-----------------------------------------------------------------------

### Detailed Gene Information

```{r gene-details}
output$gene_details <- renderUI({
  gene <- selected_gene()
  
  if (is.null(gene)) {
    return(div(
      h3("No Gene Selected"),
      p("Please select a gene from the Gene Table tab to view detailed information."),
      style = "padding: 50px; text-align: center; color: #888;"
    ))
  }
  
  # Get the gene data
  gene_data <- processed_data %>%
    filter(mouse_gene_symbol == gene) %>%
    head(1)
  
  if (nrow(gene_data) == 0) {
    return(div(
      h3("Gene Information Not Available"),
      style = "padding: 50px; text-align: center; color: #888;"
    ))
  }
  
  # Format PubMed IDs as clickable links
  pubmed_links <- format_pubmed_links(gene_data$pubmedID)
  
  # Create a detailed info panel
  div(
    class = "gene-details-panel",
    style = "padding: 20px;",
    
    # Gene header
    div(
      class = "gene-header",
      style = "margin-bottom: 30px; border-bottom: 1px solid #ddd; padding-bottom: 10px;",
      h2(gene_data$mouse_gene_symbol, style = "margin-top: 0;"),
      div(
        style = "display: flex; flex-wrap: wrap;",
        div(
          style = "margin-right: 30px;",
          h4("Basic Information"),
          p(strong("Ensembl ID: "), gene_data$mouse_ensembl_id),
          p(strong("Expression (CPM): "), round(gene_data$avgenes_cpm, 2)),
          p(strong("Trait-Drug Count: "), gene_data$n_trait_drug)
        ),
        div(
          style = "min-width: 300px;",
          h4("External Resources"),
          p(
            a(
              href = sprintf("https://www.ensembl.org/Mus_musculus/Gene/Summary?g=%s", gene_data$mouse_ensembl_id),
              "View in Ensembl",
              target = "_blank"
            )
          ),
          p(
            a(
              href = sprintf("https://www.ncbi.nlm.nih.gov/gene/?term=%s[gene]+AND+mouse[organism]", gene_data$mouse_gene_symbol),
              "View in NCBI Gene",
              target = "_blank"
            )
          ),
          p(
            a(
              href = sprintf("https://www.mousephenotype.org/data/genes/%s", gene_data$mouse_ensembl_id),
              "View in IMPC",
              target = "_blank"
            )
          )
        )
      )
    ),
    
    # Details in tabs
    tabsetPanel(
      tabPanel(
        "Traits & Drugs",
        div(
          style = "padding: 15px;",
          h4("Associated Traits"),
          p(paste(unlist(gene_data$trait_list), collapse = ", ")),
          
          h4("Associated Drugs"),
          p(paste(unlist(gene_data$drug_list), collapse = ", ")),
          
          h4("Disease Associations"),
          p(if(is.na(gene_data$disease) || gene_data$disease == "") "None" else gene_data$disease)
        )
      ),
      
      tabPanel(
        "Ontology",
        div(
          style = "padding: 15px;",
          h4("Ontology Terms"),
          p(if(is.na(gene_data$ontology) || gene_data$ontology == "") "None" else gene_data$ontology)
        )
      ),
      
      tabPanel(
        "Comments",
        div(
          style = "padding: 15px;",
          h4("Comments"),
          p(if(is.na(gene_data$comments) || gene_data$comments == "") "No comments available" else gene_data$comments)
        )
      ),
      
      tabPanel(
        "Literature",
        div(
          style = "padding: 15px;",
          h4("PubMed References"),
          if(is.na(gene_data$pubmedID) || gene_data$pubmedID == "") {
            p("No PubMed references available")
          } else {
            HTML(paste0("<p>", pubmed_links, "</p>"))
          }
        )
      )
    )
  )
})

htmlOutput("gene_details")
```

Row
-----------------------------------------------------------------------

### Trait-Drug Combinations for Selected Gene

```{r trait-drug-combinations}
output$trait_drug_table <- renderDT({
  gene <- selected_gene()
  
  if (is.null(gene)) {
    return(NULL)
  }
  
  # Get the gene data
  gene_data <- processed_data %>%
    filter(mouse_gene_symbol == gene) %>%
    head(1)
  
  if (nrow(gene_data) == 0 || is.na(gene_data$trait_drug) || gene_data$trait_drug == "") {
    return(NULL)
  }
  
  # Parse trait-drug combinations
  trait_drugs <- unlist(strsplit(gene_data$trait_drug, ", "))
  trait_drug_df <- data.frame(
    Combination = trait_drugs,
    stringsAsFactors = FALSE
  )
  
  # Split into trait and drug columns
  trait_drug_df <- trait_drug_df %>%
    mutate(
      Trait = sapply(strsplit(Combination, ":"), function(x) if(length(x) > 0) x[1] else NA),
      Drug = sapply(strsplit(Combination, ":"), function(x) if(length(x) > 1) x[2] else NA)
    )
  
  datatable(trait_drug_df %>% select(Trait, Drug, Combination),
            options = list(
              pageLength = 10,
              dom = 'lrtip'
            ),
            selection = 'none',
            rownames = FALSE,
            caption = paste("Trait-Drug Combinations for", gene))
})

DTOutput("trait_drug_table")
```